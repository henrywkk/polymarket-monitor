# Phase 3: Alert System & Delivery - Testing Guide

**Status:** Implementation Complete  
**Date:** January 2026

---

## Overview

Phase 3 implements the alert delivery system that processes alerts from Redis and delivers them through multiple notification channels (webhook, WebSocket, email).

---

## Components Implemented

### 1. Alert Dispatcher Service
- **File:** `backend/src/services/alert-dispatcher.ts`
- **Purpose:** Processes alerts from Redis queue, formats messages, routes to channels
- **Status:** ‚úÖ Complete

### 2. Alert Throttling Service
- **File:** `backend/src/services/alert-throttle.ts`
- **Purpose:** Prevents alert spam with cooldown periods
- **Status:** ‚úÖ Complete

### 3. Notification Channels
- **File:** `backend/src/services/notification-channels.ts`
- **Channels:**
  - ‚úÖ Webhook Channel (fully implemented)
  - ‚úÖ WebSocket Channel (for frontend)
  - ‚ö†Ô∏è Email Channel (placeholder, not yet implemented)

### 4. API Routes
- **File:** `backend/src/routes/alerts.ts`
- **Endpoints:**
  - `GET /api/alerts` - List recent alerts
  - `GET /api/alerts/stats` - Alert statistics
  - `GET /api/alerts/:marketId` - Alerts for specific market

---

## Configuration

### Environment Variables

```bash
# Alert Throttling
ALERT_THROTTLE_COOLDOWN=600              # Default cooldown (10 minutes)
ALERT_CRITICAL_BYPASS_THROTTLE=true      # Critical alerts bypass throttling
ALERT_HIGH_COOLDOWN=300                  # High severity cooldown (5 minutes)
ALERT_MEDIUM_COOLDOWN=600                # Medium severity cooldown (10 minutes)
ALERT_LOW_COOLDOWN=600                   # Low severity cooldown (10 minutes)

# Webhook Channel
WEBHOOK_ENABLED=true                     # Enable webhook delivery
WEBHOOK_URL=https://your-webhook-endpoint.com/alerts
WEBHOOK_SECRET=your-secret-key           # Optional: for signature verification
WEBHOOK_TIMEOUT=5000                     # Request timeout (ms)
WEBHOOK_RETRY_ATTEMPTS=3                 # Number of retry attempts

# WebSocket Channel
WEBSOCKET_ALERTS_ENABLED=true            # Enable WebSocket broadcasting (default: true)

# Email Channel (not yet implemented)
EMAIL_ENABLED=false                      # Email notifications not yet implemented
```

---

## Testing the Alert System

### 1. Verify Alert Dispatcher is Running

**Check Logs:**
```bash
# Look for these log messages on server startup
[Alert System] Alert dispatcher started
[Alert Dispatcher] Starting alert processing...
```

**Check Status:**
```bash
# The dispatcher should be polling Redis every 2 seconds
# Look for log messages when alerts are processed
```

### 2. Test Alert Generation (Phase 2)

Alerts are generated by Phase 2's anomaly detection. To verify alerts are being created:

**Check Redis:**
```bash
# Connect to Redis
redis-cli

# Check pending alerts queue
LLEN alerts:pending

# View recent alerts
LRANGE alerts:pending 0 9

# Check alerts for specific market
LRANGE alerts:market:131313 0 9
```

**Check Logs:**
```bash
# Look for alert generation messages
[Alert Generated] INSIDER_MOVE: Price 32.50% + Volume 64.94œÉ spike (Market: 131313)
```

### 3. Test Alert Processing

**Monitor Dispatcher Logs:**
```bash
# Look for these messages when alerts are processed
[Alert Dispatcher] Alert delivered: insider_move for market 131313
[Webhook Channel] Alert delivered successfully (attempt 1)
[WebSocket Channel] Alert broadcasted
```

**Check Throttling:**
```bash
# If an alert is throttled, you'll see:
[Alert Dispatcher] Alert throttled: insider_move for market 131313 (next alert in 300s)
```

### 4. Test Webhook Delivery

**Setup Test Webhook:**
1. Use a webhook testing service like [webhook.site](https://webhook.site) or [ngrok](https://ngrok.com)
2. Set `WEBHOOK_URL` to your test endpoint
3. Set `WEBHOOK_ENABLED=true`

**Verify Delivery:**
```bash
# Check your webhook endpoint for incoming POST requests
# Payload format:
{
  "alert": {
    "type": "insider_move",
    "severity": "critical",
    "title": "üö® INSIDER MOVE Detected",
    "message": "Price moved 32.50% (32.50pp) in <1min with 64.94œÉ volume spike | Market: Infinex public sale total commitments? (>$5M)",
    "marketId": "131313",
    "marketName": "Infinex public sale total commitments?",
    "outcomeName": ">$5M",
    "category": "Crypto",
    "timestamp": "2026-01-09T12:00:00.000Z",
    "polymarketUrl": "https://polymarket.com/event/infinex-public-sale-total-commitments"
  },
  "metrics": {
    "priceChange": 32.5,
    "absoluteChange": 0.325,
    "volumeZScore": 64.94
  },
  "signature": "base64-signature-if-secret-set"
}
```

**Test Retry Logic:**
- Temporarily disable your webhook endpoint
- Generate an alert
- Check logs for retry attempts:
  ```
  [Webhook Channel] Error on attempt 1/3: ...
  [Webhook Channel] Error on attempt 2/3: ...
  [Webhook Channel] Failed to deliver alert after 3 attempts
  ```

### 5. Test WebSocket Broadcasting

**Frontend Integration:**
```typescript
// In your frontend, listen for alert events
socket.on('alert', (alert) => {
  console.log('Alert received:', alert);
  // Display alert in UI
});
```

**Verify Broadcasting:**
- Connect to WebSocket server
- Generate an alert
- Check if `alert` event is received

### 6. Test Alert Throttling

**Test Per-Market Cooldown:**
1. Generate an alert for market `131313`
2. Immediately generate another alert for the same market
3. Second alert should be throttled:
   ```
   [Alert Dispatcher] Alert throttled: insider_move for market 131313 (next alert in 600s)
   ```

**Test Critical Alert Bypass:**
1. Generate a critical alert
2. Generate another critical alert immediately
3. Both should be delivered (critical bypasses throttling)

**Test Severity-Based Cooldowns:**
- High severity: 5-minute cooldown
- Medium/Low severity: 10-minute cooldown
- Critical: No cooldown (if `ALERT_CRITICAL_BYPASS_THROTTLE=true`)

**Check Throttle Keys in Redis:**
```bash
redis-cli

# Check throttle for a market
GET throttle:market:131313

# Check throttle for market+type
GET throttle:market:131313:insider_move

# Clear throttle (for testing)
DEL throttle:market:131313
DEL throttle:market:131313:insider_move
```

### 7. Test API Endpoints

**List Recent Alerts:**
```bash
curl "http://localhost:3000/api/alerts?limit=10"
```

**Get Alert Statistics:**
```bash
curl "http://localhost:3000/api/alerts/stats"
```

**Get Alerts for Specific Market:**
```bash
curl "http://localhost:3000/api/alerts/131313"
```

**Filter by Type:**
```bash
curl "http://localhost:3000/api/alerts?type=insider_move"
```

---

## Manual Alert Testing

### Create Test Alert Manually

**Using Redis:**
```bash
redis-cli

# Push a test alert to the queue
LPUSH alerts:pending '{
  "type": "insider_move",
  "marketId": "131313",
  "outcomeId": "12549329...",
  "tokenId": "12549329...",
  "severity": "critical",
  "message": "TEST: Price moved 32.50% + Volume 64.94œÉ spike",
  "data": {
    "priceChange": 32.5,
    "absoluteChange": 0.325,
    "volumeZScore": 64.94
  },
  "timestamp": 1704800000000
}'
```

**The dispatcher should process it within 2 seconds.**

### Test Alert Formatting

**Check Formatted Alert:**
- The dispatcher fetches market name from database
- Formats message based on alert type
- Includes Polymarket URL if slug is available

**Verify Format:**
- Check logs for formatted message
- Check webhook payload for formatted alert
- Verify market name and outcome name are included

---

## Troubleshooting

### Alerts Not Being Processed

**Check:**
1. Is dispatcher running? (check startup logs)
2. Are alerts in Redis queue? (`LLEN alerts:pending`)
3. Check dispatcher logs for errors

**Common Issues:**
- Redis connection problems
- Database connection issues (for market name lookup)
- Channel delivery failures

### Webhook Not Receiving Alerts

**Check:**
1. `WEBHOOK_ENABLED=true`?
2. `WEBHOOK_URL` is correct?
3. Webhook endpoint is accessible?
4. Check webhook channel logs for errors

**Debug:**
- Temporarily enable verbose logging
- Check network connectivity
- Verify webhook endpoint accepts POST requests

### Alerts Being Throttled Too Aggressively

**Adjust:**
- Reduce `ALERT_THROTTLE_COOLDOWN`
- Set `ALERT_CRITICAL_BYPASS_THROTTLE=true`
- Adjust severity-specific cooldowns

### Alert Formatting Issues

**Check:**
- Market exists in database
- Outcome ID is correct
- Market slug is available (for Polymarket URL)

**Fallback:**
- If market not found, alert still delivered but without market name
- Polymarket URL only included if slug is available

---

## Performance Metrics

### Expected Performance

- **Alert Processing Latency:** < 5 seconds from generation to delivery
- **Webhook Delivery:** < 2 seconds (excluding network latency)
- **Throttle Check:** < 10ms
- **Market Lookup:** < 50ms

### Monitoring

**Key Metrics to Track:**
- Alerts processed per minute
- Webhook delivery success rate
- Throttled alerts count
- Average processing time
- Channel delivery failures

---

## Next Steps

After Phase 3 testing is complete:

1. **Phase 4: New Market/Outcome Detection**
   - Detect new markets and outcomes
   - Trigger "New Narrative" alerts

2. **Frontend Integration**
   - Display alerts in UI
   - Real-time alert notifications
   - Alert history page

3. **Alert Preferences**
   - User-specific filters
   - Custom notification channels
   - Alert preferences API

---

## Success Criteria

‚úÖ **Alert Dispatcher Operational**
- Processes alerts from Redis queue
- Formats alerts correctly
- Routes to enabled channels

‚úÖ **Throttling Working**
- Prevents duplicate alerts (1 per market per 10min)
- Critical alerts bypass throttling
- Severity-based cooldowns applied

‚úÖ **Webhook Delivery**
- Alerts delivered to webhook endpoint
- Retry logic works on failures
- Payload format is correct

‚úÖ **WebSocket Broadcasting**
- Alerts broadcasted to connected clients
- Frontend receives alert events

‚úÖ **API Endpoints**
- `/api/alerts` returns recent alerts
- `/api/alerts/stats` returns statistics
- `/api/alerts/:marketId` returns market-specific alerts
